---
/**
 * SmoothScroll - Lenis smooth scrolling + GSAP ScrollTrigger
 * 
 * Provides buttery smooth scrolling and professional scroll-triggered animations.
 * Include once in your layout, typically in the head slot.
 * 
 * Features:
 * - Lenis smooth scroll (60fps)
 * - GSAP ScrollTrigger integration
 * - Staggered reveal animations
 * - Parallax effects
 * - Text split animations
 * 
 * @example
 * <SmoothScroll />
 * 
 * Then add classes to elements:
 * - .gsap-reveal - Fade up on scroll
 * - .gsap-reveal-left - Slide from left
 * - .gsap-reveal-right - Slide from right
 * - .gsap-parallax - Parallax effect
 * - .gsap-text-reveal - Split text animation
 * - .gsap-stagger - Stagger children
 */

interface Props {
  /** Enable smooth scroll */
  smoothScroll?: boolean;
  /** Smooth scroll lerp value (0-1, lower = smoother) */
  lerp?: number;
  /** Enable on mobile */
  mobileEnabled?: boolean;
}

const {
  smoothScroll = true,
  lerp = 0.1,
  mobileEnabled = false,
} = Astro.props;
---

<!-- GSAP + ScrollTrigger + Lenis -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>
<script src="https://unpkg.com/lenis@1.1.13/dist/lenis.min.js" defer></script>

<script define:vars={{ smoothScroll, lerp, mobileEnabled }}>
  // Wait for all scripts to load
  window.addEventListener('load', () => {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // Initialize Lenis smooth scroll
    let lenis = null;
    if (smoothScroll && (!isMobile || mobileEnabled)) {
      lenis = new window.Lenis({
        lerp: lerp,
        smoothWheel: true,
        syncTouch: false,
      });

      // Connect Lenis to GSAP ScrollTrigger
      lenis.on('scroll', window.ScrollTrigger.update);

      window.gsap.ticker.add((time) => {
        lenis.raf(time * 1000);
      });

      window.gsap.ticker.lagSmoothing(0);
    }

    // Register ScrollTrigger
    window.gsap.registerPlugin(window.ScrollTrigger);

    // ===========================================
    // Animation Defaults
    // ===========================================
    const defaultEase = 'power3.out';
    const defaultDuration = 1.2;

    // ===========================================
    // Reveal Animations
    // ===========================================
    
    // Fade up reveal
    window.gsap.utils.toArray('.gsap-reveal').forEach((el) => {
      window.gsap.fromTo(el, 
        { 
          y: 60, 
          opacity: 0 
        },
        {
          y: 0,
          opacity: 1,
          duration: defaultDuration,
          ease: defaultEase,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // Slide from left
    window.gsap.utils.toArray('.gsap-reveal-left').forEach((el) => {
      window.gsap.fromTo(el,
        { 
          x: -80, 
          opacity: 0 
        },
        {
          x: 0,
          opacity: 1,
          duration: defaultDuration,
          ease: defaultEase,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // Slide from right
    window.gsap.utils.toArray('.gsap-reveal-right').forEach((el) => {
      window.gsap.fromTo(el,
        { 
          x: 80, 
          opacity: 0 
        },
        {
          x: 0,
          opacity: 1,
          duration: defaultDuration,
          ease: defaultEase,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // Scale up reveal
    window.gsap.utils.toArray('.gsap-reveal-scale').forEach((el) => {
      window.gsap.fromTo(el,
        { 
          scale: 0.9, 
          opacity: 0 
        },
        {
          scale: 1,
          opacity: 1,
          duration: defaultDuration,
          ease: defaultEase,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // ===========================================
    // Stagger Animations
    // ===========================================
    
    window.gsap.utils.toArray('.gsap-stagger').forEach((container) => {
      const children = container.children;
      window.gsap.fromTo(children,
        { 
          y: 40, 
          opacity: 0 
        },
        {
          y: 0,
          opacity: 1,
          duration: 0.8,
          ease: defaultEase,
          stagger: 0.1,
          scrollTrigger: {
            trigger: container,
            start: 'top 80%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // ===========================================
    // Parallax Effects
    // ===========================================
    
    window.gsap.utils.toArray('.gsap-parallax').forEach((el) => {
      const speed = el.dataset.speed || 0.5;
      window.gsap.to(el, {
        y: () => window.innerHeight * speed * -0.5,
        ease: 'none',
        scrollTrigger: {
          trigger: el,
          start: 'top bottom',
          end: 'bottom top',
          scrub: true,
        },
      });
    });

    // Image parallax (slower)
    window.gsap.utils.toArray('.gsap-parallax-slow').forEach((el) => {
      window.gsap.to(el, {
        y: -100,
        ease: 'none',
        scrollTrigger: {
          trigger: el,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 1,
        },
      });
    });

    // ===========================================
    // Text Split Animations
    // ===========================================
    
    window.gsap.utils.toArray('.gsap-text-reveal').forEach((el) => {
      // Split text into words
      const text = el.textContent;
      const words = text.split(' ');
      el.innerHTML = words.map(word => 
        `<span class="gsap-word"><span class="gsap-word-inner">${word}</span></span>`
      ).join(' ');

      const wordInners = el.querySelectorAll('.gsap-word-inner');
      
      window.gsap.fromTo(wordInners,
        { 
          y: '100%',
          opacity: 0,
        },
        {
          y: '0%',
          opacity: 1,
          duration: 0.8,
          ease: 'power3.out',
          stagger: 0.03,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // Character reveal for headlines
    window.gsap.utils.toArray('.gsap-chars-reveal').forEach((el) => {
      const text = el.textContent;
      const chars = text.split('');
      el.innerHTML = chars.map(char => 
        char === ' ' ? ' ' : `<span class="gsap-char">${char}</span>`
      ).join('');

      const charSpans = el.querySelectorAll('.gsap-char');
      
      window.gsap.fromTo(charSpans,
        { 
          y: 50,
          opacity: 0,
          rotateX: -90,
        },
        {
          y: 0,
          opacity: 1,
          rotateX: 0,
          duration: 0.6,
          ease: 'back.out(1.7)',
          stagger: 0.02,
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // ===========================================
    // Line Reveal (for images/sections)
    // ===========================================
    
    window.gsap.utils.toArray('.gsap-line-reveal').forEach((el) => {
      window.gsap.fromTo(el,
        { 
          clipPath: 'inset(0 100% 0 0)',
        },
        {
          clipPath: 'inset(0 0% 0 0)',
          duration: 1.5,
          ease: 'power4.inOut',
          scrollTrigger: {
            trigger: el,
            start: 'top 80%',
            toggleActions: 'play none none none',
          },
        }
      );
    });

    // ===========================================
    // Counter Animation
    // ===========================================
    
    window.gsap.utils.toArray('.gsap-counter').forEach((el) => {
      const target = parseInt(el.dataset.target || el.textContent);
      const suffix = el.dataset.suffix || '';
      const prefix = el.dataset.prefix || '';
      
      window.gsap.fromTo(el,
        { textContent: 0 },
        {
          textContent: target,
          duration: 2,
          ease: 'power2.out',
          snap: { textContent: 1 },
          scrollTrigger: {
            trigger: el,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
          onUpdate: function() {
            el.textContent = prefix + Math.round(this.targets()[0].textContent) + suffix;
          },
        }
      );
    });

    // ===========================================
    // Horizontal Scroll Section
    // ===========================================
    
    const horizontalSections = document.querySelectorAll('.gsap-horizontal');
    horizontalSections.forEach((section) => {
      const wrapper = section.querySelector('.gsap-horizontal-wrapper');
      if (!wrapper) return;

      const items = wrapper.children;
      const totalWidth = Array.from(items).reduce((acc, item) => acc + item.offsetWidth, 0);
      
      window.gsap.to(wrapper, {
        x: () => -(totalWidth - window.innerWidth + 100),
        ease: 'none',
        scrollTrigger: {
          trigger: section,
          start: 'top top',
          end: () => `+=${totalWidth}`,
          scrub: 1,
          pin: true,
          anticipatePin: 1,
        },
      });
    });

    // Refresh ScrollTrigger after images load
    window.addEventListener('load', () => {
      window.ScrollTrigger.refresh();
    });
  });
</script>

<style is:global>
  /* Text split styles */
  .gsap-word {
    display: inline-block;
    overflow: hidden;
    vertical-align: top;
  }

  .gsap-word-inner {
    display: inline-block;
  }

  .gsap-char {
    display: inline-block;
    transform-origin: bottom;
  }

  /* Horizontal scroll */
  .gsap-horizontal {
    overflow: hidden;
  }

  .gsap-horizontal-wrapper {
    display: flex;
    width: max-content;
  }

  /* Hide elements before animation (prevents flash) */
  .gsap-reveal,
  .gsap-reveal-left,
  .gsap-reveal-right,
  .gsap-reveal-scale {
    opacity: 0;
  }

  /* Reduced motion - show everything immediately */
  @media (prefers-reduced-motion: reduce) {
    .gsap-reveal,
    .gsap-reveal-left,
    .gsap-reveal-right,
    .gsap-reveal-scale,
    .gsap-stagger > * {
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>
