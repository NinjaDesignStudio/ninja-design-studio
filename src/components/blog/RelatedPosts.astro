---
/**
 * RelatedPosts - Shows related blog posts
 * 
 * Displays related posts based on category or tags.
 * Falls back to recent posts if no matches.
 * 
 * @example
 * <RelatedPosts 
 *   currentSlug="my-post-slug"
 *   category="design"
 *   limit={3}
 * />
 */
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  /** Current post slug to exclude */
  currentSlug: string;
  /** Category to match */
  category?: string;
  /** Tags to match */
  tags?: string[];
  /** Number of posts to show */
  limit?: number;
  /** Title for the section */
  title?: string;
}

const {
  currentSlug,
  category,
  tags = [],
  limit = 3,
  title = 'Related Articles',
} = Astro.props;

// Get all posts except current
const allPosts = await getCollection('blog');
const otherPosts = allPosts.filter(post => post.slug !== currentSlug);

// Score posts by relevance
function scorePost(post: CollectionEntry<'blog'>): number {
  let score = 0;
  
  // Category match (high priority)
  if (category && post.data.category === category) {
    score += 10;
  }
  
  // Tag matches
  if (tags.length > 0 && post.data.tags) {
    const matchingTags = tags.filter(tag => post.data.tags?.includes(tag));
    score += matchingTags.length * 3;
  }
  
  // Recency bonus (newer = higher)
  const daysSincePublished = Math.floor(
    (Date.now() - new Date(post.data.date).getTime()) / (1000 * 60 * 60 * 24)
  );
  score += Math.max(0, 5 - daysSincePublished / 30); // Up to 5 points for recent posts
  
  return score;
}

// Sort by relevance score, then by date
const relatedPosts = otherPosts
  .map(post => ({ post, score: scorePost(post) }))
  .sort((a, b) => b.score - a.score || new Date(b.post.data.date).getTime() - new Date(a.post.data.date).getTime())
  .slice(0, limit)
  .map(({ post }) => post);
---

{relatedPosts.length > 0 && (
  <aside class="related-posts">
    <div class="related-header">
      <h3 class="related-title">{title}</h3>
      <a href="/blog" class="related-see-all">
        View all
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
    
    <div class="related-grid">
      {relatedPosts.map((post) => {
        const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        
        return (
          <a href={`/blog/${post.slug}`} class="related-card">
            {post.data.image && (
              <div class="card-image">
                <img src={post.data.image} alt={post.data.title} loading="lazy" />
              </div>
            )}
            <div class="card-content">
              <span class="card-category">{post.data.category}</span>
              <h4 class="card-title">{post.data.title}</h4>
              <span class="card-date">{formattedDate}</span>
            </div>
          </a>
        );
      })}
    </div>
  </aside>
)}

<style>
  .related-posts {
    margin: 4rem 0;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 24px;
  }

  .related-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .related-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--white);
    margin: 0;
  }

  .related-see-all {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.5);
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .related-see-all:hover {
    color: var(--neon-cyan);
  }

  .related-see-all svg {
    transition: transform 0.3s ease;
  }

  .related-see-all:hover svg {
    transform: translateX(4px);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .related-card {
    display: flex;
    flex-direction: column;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 16px;
    overflow: hidden;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .related-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 0, 110, 0.3);
    transform: translateY(-4px);
  }

  .card-image {
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .related-card:hover .card-image img {
    transform: scale(1.05);
  }

  .card-content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .card-category {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--neon-pink);
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--white);
    line-height: 1.4;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-date {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: auto;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .related-posts {
      padding: 2rem;
      margin: 3rem 0;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
